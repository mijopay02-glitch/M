<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>R√©clamer Bonus</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f9fc; padding:20px; }
    .card { background:white; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); max-width:500px; margin:auto; }
    h2 { color:#333; text-align:center; }
    p { font-size:16px; }
    table { width:100%; border-collapse:collapse; margin:15px 0; }
    th, td { border:1px solid #ddd; padding:8px; text-align:center; }
    th { background:#28a745; color:white; }
    tr.highlight { background:#d4edda; font-weight:bold; }
    button { width:100%; padding:12px; border:none; border-radius:8px; background:#28a745; color:white; cursor:pointer; font-size:16px; margin-top:10px; }
    button:disabled { background:gray; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üéÅ Bonus Affili√©</h2>
    <p>Nombre d‚Äôaffili√©s : <span id="nbreAffiche">0</span></p>

    <h3>üìä Grille des Bonus</h3>
    <table id="bonusTable">
      <tr>
        <th>Affili√©s requis</th>
        <th>Montant du Bonus</th>
      </tr>
    </table>

    <p>Bonus disponible : <span id="bonusMontant">Aucun</span></p>
    <button id="btnBonus" disabled>R√©clamer mon bonus</button>
  </div>

  <script>

  // üéØ Grille des bonus
  const bonusPaliers = [
    { seuil: 5, montant: 250 },
    { seuil: 10, montant: 600 },
    { seuil: 20, montant: 1500 },
    { seuil: 40, montant: 4000 },
    { seuil: 100, montant: 10000 }
  ];

  // üìå Charger l'utilisateur depuis localStorage
  const userString = localStorage.getItem("user");
  let nbreAffilie = 0;
  let userId = null;
  let userObj = null;

  if (userString) {
    try {
      userObj = JSON.parse(userString);
      nbreAffilie = parseInt(userObj.nbreaffilie || "0", 10);
      userId = userObj.userId || userObj.id || userObj.userid || null;
    } catch (e) {
      console.error("Erreur parsing user:", e);
    }
  }

  document.getElementById("nbreAffiche").textContent = nbreAffilie;

  // üìå Remplir le tableau des paliers
  const table = document.getElementById("bonusTable");
  let bonusTrouve = null;
  bonusPaliers.forEach(palier => {
    const row = document.createElement("tr");
    if (nbreAffilie >= palier.seuil) {
      bonusTrouve = palier;
      row.classList.add("highlight");
    }
    row.innerHTML = `<td>${palier.seuil}</td><td>${palier.montant} HTG</td>`;
    table.appendChild(row);
  });

  // üìå Mettre √† jour le bonus disponible
  const btnBonus = document.getElementById("btnBonus");
  if (bonusTrouve && !userObj.bonusPris) {
    document.getElementById("bonusMontant").textContent = bonusTrouve.montant + " HTG";
    btnBonus.disabled = false;
  }

  // üìå Action du bouton : envoie la demande au backend
  btnBonus.addEventListener("click", async () => {
    if (!bonusTrouve) return alert("Aucun bonus disponible");
    if (!userId) return alert("Erreur: utilisateur non identifi√©");

    try {
      const res = await fetch("https://bonus.mijocomplexe.workers.dev/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "bonus",
          userId: userId,
          montant: bonusTrouve.montant
        })
      });

      const data = await res.json();
      if (data.status === "success") {
        alert(`üéâ Bonus de ${bonusTrouve.montant} HTG cr√©dit√© sur ton compte !`);

        // ‚úÖ D√©sactiver le bouton pour √©viter de r√©clamer plusieurs fois
        btnBonus.disabled = true;

        // ‚úÖ Mettre √† jour le solde dans localStorage
        userObj.Solde = data.newSolde;
        userObj.bonusPris = true; // flag pour indiquer que le bonus a √©t√© pris
        localStorage.setItem("user", JSON.stringify(userObj));

        // Mettre √† jour l'affichage
        document.getElementById("bonusMontant").textContent = "Aucun";

      } else {
        alert("Erreur: " + data.message);
      }
    } catch (err) {
      alert("Erreur r√©seau: " + err.message);
    }
  });


  </script>
</body>
</html>
