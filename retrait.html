<!DOCTYPE html>
<html lang="fr">
<head>
      <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-K43FXR4W');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retrait Client - MIJO PAY</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .container { background-color: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); text-align: center; width: 90%; max-width: 500px; }
        h1 { color: #333; }
        .client-info { font-size: 1.2em; margin-bottom: 20px; }
        #client-solde { font-weight: bold; color: #28a745; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .action-button { width: 100%; padding: 15px; font-size: 1em; color: #fff; background-color: #007BFF; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s ease; }
        .action-button:hover { background-color: #0056b3; }
        #status-message { margin-top: 20px; font-weight: bold; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 2s linear infinite; display: none; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .qr-code-box, .transaction-code-box { display: none; margin-top: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background-color: #f9f9f9; }
        .qr-code-box h3, .transaction-code-box h3 { margin-top: 0; }
        #transaction-code { font-size: 2em; font-weight: bold; color: #dc3545; }
        .qr-code-text { font-size: 0.9em; color: #555; }
        #countdown-timer { font-size: 1.2em; color: #dc3545; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Retrait Client MIJO</h1>
        <div class="client-info">
            <p>Connecté en tant que : <span id="client-name"></span></p>
            <p>Solde de votre compte : <span id="client-solde"></span> Gourdes</p>
        </div>
        <form id="retrait-form">
            <div class="form-group">
                <label for="montant">Montant à retirer</label>
                <input type="number" id="montant" required>
            </div>
            <button type="submit" class="action-button">Générer le code de retrait</button>
            <div class="loader" id="loader"></div>
            <div id="status-message"></div>
        </form>

        <div class="transaction-code-box" id="code-box">
            <h3>Votre code de retrait</h3>
            <p id="transaction-code"></p>
            <p id="countdown-timer">Expire dans 2:00</p>
            <p class="qr-code-text">Présentez ce code à l'agent.</p>
        </div>
    </div>
   <script>
    const form = document.getElementById('retrait-form');
    const loader = document.getElementById('loader');
    const statusMessage = document.getElementById('status-message');
    const codeBox = document.getElementById('code-box');
    const transactionCodeSpan = document.getElementById('transaction-code');
    const countdownTimer = document.getElementById('countdown-timer');
    const clientNameSpan = document.getElementById('client-name');
    const clientSoldeSpan = document.getElementById('client-solde');

    const API_URL = 'https://retrait.mijocomplexe.workers.dev/';
    const EXPIRATION_TIME = 120; // 2 minutes en secondes

    let user = JSON.parse(localStorage.getItem('user'));
    let countdownInterval;
    let statusCheckInterval; // Nouveau minuteur

    function displayClientData() {
        if (user && user.NomUtilisateur) {
            clientNameSpan.textContent = user.NomUtilisateur;
            clientSoldeSpan.textContent = user.Solde ? user.Solde.toFixed(2) : '0.00';
        } else {
            window.location.href = 'index.html';
        }
    }
    displayClientData();

    function startCountdown() {
        let timeLeft = EXPIRATION_TIME;
        countdownTimer.style.color = '#dc3545';
        
        countdownInterval = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdownTimer.textContent = `Expire dans ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            if (timeLeft <= 0) {
                clearInterval(countdownInterval);
                transactionCodeSpan.textContent = "Code expiré";
                countdownTimer.textContent = "";
                statusMessage.textContent = "Le code de transaction a expiré. Veuillez générer un nouveau code.";
                statusMessage.style.color = "red";
                clearInterval(statusCheckInterval); // Arrêter la vérification de statut
            }
            timeLeft--;
        }, 1000);
    }
    
    // NOUVELLE FONCTION pour vérifier le statut de la transaction
    async function checkTransactionStatus(transactionCode) {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'verifierStatut', transactionCode: transactionCode })
            });

            const result = await response.json();

            if (result.status === "success") {
                // Arrêter les deux minuteurs
                clearInterval(countdownInterval);
                clearInterval(statusCheckInterval);
                
                // Mettre à jour l'interface utilisateur
                transactionCodeSpan.textContent = "Transaction réussie!";
                countdownTimer.textContent = "";
                statusMessage.textContent = "Votre retrait a été confirmé par l'agent.";
                statusMessage.style.color = "green";
                
                // Rediriger après un court délai pour que l'utilisateur lise le message
                setTimeout(() => {
                    window.location.href = 'menuretrai.html';
                }, 3000);
            }
        } catch (error) {
            console.error('Erreur de vérification de statut:', error);
        }
    }

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const montant = parseFloat(document.getElementById('montant').value);

        if (isNaN(montant) || montant <= 0) {
            statusMessage.textContent = "Veuillez entrer un montant valide.";
            statusMessage.style.color = "red";
            return;
        }
        const frais = montant * 0.04;
        const montantTotal = montant + frais;

        if (montantTotal > user.Solde) {
            statusMessage.textContent = "Solde insuffisant pour ce retrait, y compris les frais.";
            statusMessage.style.color = "red";
            return;
        }

        statusMessage.textContent = "Génération du code en cours...";
        statusMessage.style.color = "blue";
        loader.style.display = 'block';
        codeBox.style.display = 'none';
        clearInterval(countdownInterval); // S'assurer que le minuteur est arrêté

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'genererCodeRetrait', clientId: user.userId, montant: montant })
            });

            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const result = await response.json();

            if (result.status === "success") {
                user.Solde = user.Solde - montantTotal;
                localStorage.setItem('user', JSON.stringify(user));
                clientSoldeSpan.textContent = user.Solde.toFixed(2);
                transactionCodeSpan.textContent = result.transactionCode;
                codeBox.style.display = 'block';
                statusMessage.textContent = "Code de retrait généré. Montrez-le à l'agent.";
                statusMessage.style.color = "green";
                startCountdown();
                saveToHistory("Retrait", montantTotal, "Succès", "Agent MIJO PAY", user.userId);
                // Démarrer la vérification de statut toutes les 5 secondes
                statusCheckInterval = setInterval(() => {
                    checkTransactionStatus(result.transactionCode);
                }, 5000);
            } else {
                statusMessage.textContent = `Erreur : ${result.message}`;
                statusMessage.style.color = "red";
            }

        } catch (error) {
            console.error('Erreur de génération de code:', error);
            statusMessage.textContent = `Erreur de connexion au serveur. ${error.message}`;
            statusMessage.style.color = "red";
        } finally {
            loader.style.display = 'none';
        }
    });
       function saveToHistory(type, amount, status, recipient, userId) {
        const historyKey = `transactions_${userId}`;
        let history = JSON.parse(localStorage.getItem(historyKey)) || [];
        const newTransaction = {
            id: Date.now(),
            type: type,
            amount: amount,
            status: status,
            recipient: recipient,
            date: new Date().toLocaleDateString()
        };
        history.push(newTransaction);
        localStorage.setItem(historyKey, JSON.stringify(history));
    }
</script>
</body>
</html>
