<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIJO Pay - Abonnement Premium</title>
    <link rel="stylesheet" href="style.css">
   <style>body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f9;
    color: #333;
    margin: 0;
    padding: 0;
    text-align: center;
}

header {
    background-color: #007bff;
    color: white;
    padding: 20px 0;
    margin-bottom: 20px;
}

.premium-section {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.user-info-card, .activation-card, .auto-renew-card { /* Ajout de auto-renew-card */
    background: white;
    padding: 25px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

/* Styles pour le statut */
#premiumStatusDisplay, #autoRenewStatusDisplay {
    font-weight: bold;
}
.premium-active, .renew-active {
    color: green;
}
.premium-inactive, .renew-inactive {
    color: red;
}


/* Styles des boutons */
button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #1e7e34;
}

.secondary-button {
    background-color: #dc3545; /* Rouge pour d√©sactiver */
}

.secondary-button:hover {
    background-color: #c82333;
}

.note {
    font-size: 0.9em;
    color: #666;
    margin-top: 15px;
}

/* Style de l'historique */
#premiumHistory {
    text-align: left;
    background: #e9ecef;
    padding: 20px;
    border-radius: 8px;
}

#transactionList {
    list-style: none;
    padding: 0;
}

#transactionList li {
    background: white;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 4px;
    border-left: 5px solid #007bff;
    display: flex;
    justify-content: space-between;
}</style> 
</head>
<body>

    <header>
        <h1>MIJO Premium üëë</h1>
    </header>

    <main class="premium-section">
        <div class="user-info-card">
            <h2>Statut de votre compte</h2>
            <p>ID Utilisateur: <span id="userIdDisplay">N/A</span></p>
            <p>Solde actuel: <span id="userBalanceDisplay">N/A</span> Gdes</p>
            <p>Statut Premium: <span id="premiumStatusDisplay">Non Actif ‚ùå</span></p>
        </div>

        <div class="activation-card">
            <h2>Abonnement Mensuel</h2>
            <p>Profitez de tous les avantages MIJO pour seulement **150 Gdes/mois**.</p>
            <button id="activateButton" onclick="activatePremium()">Activer MIJO Premium</button>
            <p class="note">Le premier mois sera d√©bit√© imm√©diatement.</p>
        </div>

        <div class="auto-renew-card" id="autoRenewSection" style="display:none;">
            <h2>Gestion du Renouvellement Automatique</h2>
            <p>Statut Auto-Renouvellement: <span id="autoRenewStatusDisplay" class="renew-active">Actif ‚úÖ</span></p>
            
            <button 
                id="toggleRenewButton" 
                onclick="toggleAutoRenew()"
                class="secondary-button">D√©sactiver l'Auto-Renouvellement</button>
                
            <p class="note" id="renewNote">Votre abonnement sera reconduit le mois prochain.</p>
        </div>

        <div id="premiumHistory">
            <h3>Historique des Transactions (Local)</h3>
            <ul id="transactionList">
                </ul>
        </div>
    </main>

    <script>// --- CONSTANTES GLOBALES ---
const PREMIUM_PRICE = 150;
const STORE_SCRIPT_URL = "https://mijopaypremium.mijocomplexe.workers.dev/";
// Worker g√©rant le d√©bit (activation Premium)
const GLOBAL_HISTORY_WORKER_URL = "https://votre-worker-global-history.workers.dev/"; 
// Worker sp√©cifique pour la d√©sactivation de l'auto-renouvellement (mise √† jour du casier 'Automatique')
const AUTORENEW_TOGGLE_WORKER_URL = "https://votre-worker-autorenew-toggle.workers.dev/"; 

// --- FONCTIONS AUXILIAIRES ---

/**
 * Met √† jour l'interface utilisateur avec les derni√®res donn√©es de l'utilisateur.
 * Inclut la gestion de l'auto-renouvellement.
 * @param {object} user - L'objet utilisateur du localStorage.
 */
function updateUI(user) {
    const userIdDisplay = document.getElementById('userIdDisplay');
    const userBalanceDisplay = document.getElementById('userBalanceDisplay');
    const premiumStatusDisplay = document.getElementById('premiumStatusDisplay');
    const autoRenewSection = document.getElementById('autoRenewSection');
    const autoRenewStatusDisplay = document.getElementById('autoRenewStatusDisplay');
    const toggleRenewButton = document.getElementById('toggleRenewButton');
    const renewNote = document.getElementById('renewNote');
    const activateButton = document.getElementById('activateButton');

    if (user && user.userId) {
        userIdDisplay.textContent = user.userId;
        userBalanceDisplay.textContent = user.Solde !== undefined ? user.Solde.toFixed(2) : 'N/A';
        
        const isPremium = user.EstPremium === true;
        const autoRenewActive = user.AutoRenew === true; // NOUVEAU: Par d√©faut, supposons 'true' apr√®s activation
        
        // --- Statut Premium ---
        premiumStatusDisplay.textContent = isPremium ? 'Actif ‚úÖ' : 'Non Actif ‚ùå';
        premiumStatusDisplay.classList.toggle('premium-active', isPremium);
        premiumStatusDisplay.classList.toggle('premium-inactive', !isPremium);
        activateButton.disabled = isPremium;
        activateButton.textContent = isPremium ? 'Abonnement D√©j√† Actif' : `Activer MIJO Premium (${PREMIUM_PRICE} Gdes/mois)`;

        // --- Section Auto-Renouvellement ---
        autoRenewSection.style.display = isPremium ? 'block' : 'none';

        if (isPremium) {
            autoRenewStatusDisplay.textContent = autoRenewActive ? 'Actif ‚úÖ' : 'D√©sactiv√© ‚ùå';
            autoRenewStatusDisplay.classList.toggle('renew-active', autoRenewActive);
            autoRenewStatusDisplay.classList.toggle('renew-inactive', !autoRenewActive);

            toggleRenewButton.textContent = autoRenewActive ? 'D√©sactiver l\'Auto-Renouvellement' : 'R√©activer l\'Auto-Renouvellement';
            toggleRenewButton.classList.toggle('secondary-button', autoRenewActive); // Rouge pour d√©sactiver
            toggleRenewButton.classList.toggle('secondary-button', !autoRenewActive); // Vert pour r√©activer (il faudra ajuster le CSS si vous voulez une autre couleur pour r√©activer)
            
            renewNote.textContent = autoRenewActive 
                ? 'Votre abonnement sera reconduit le mois prochain (pr√©l√®vement automatique).' 
                : 'L\'abonnement ne sera pas renouvel√© automatiquement. Vous perdrez l\'acc√®s √† la fin du cycle.';
        }

        displayLocalHistory(user.userId);
    } else {
        // Utilisateur non connect√© ou donn√©es manquantes
        userIdDisplay.textContent = 'Non Connect√©';
        userBalanceDisplay.textContent = 'N/A';
        premiumStatusDisplay.textContent = 'Non Actif ‚ùå';
        autoRenewSection.style.display = 'none';
        activateButton.disabled = false;
        activateButton.textContent = `Activer MIJO Premium (${PREMIUM_PRICE} Gdes/mois)`;
    }
}

/**
 * Enregistre une transaction dans l'historique local de l'utilisateur.
 * (Fonction inchang√©e)
 */
function saveToHistory(type, amount, status, recipient, userId) {
    const historyKey = `transactions_${userId}`;
    let history = JSON.parse(localStorage.getItem(historyKey)) || [];
    const newTransaction = {
        id: Date.now(),
        type: type,
        amount: amount,
        status: status,
        recipient: recipient,
        date: new Date().toLocaleString()
    };
    history.unshift(newTransaction);
    localStorage.setItem(historyKey, JSON.stringify(history));
    displayLocalHistory(userId);
}

/**
 * Affiche l'historique des transactions locales.
 * (Fonction inchang√©e)
 */
function displayLocalHistory(userId) {
    const transactionList = document.getElementById('transactionList');
    transactionList.innerHTML = ''; 

    if (!userId) return;

    const historyKey = `transactions_${userId}`;
    let history = JSON.parse(localStorage.getItem(historyKey)) || [];

    if (history.length === 0) {
        transactionList.innerHTML = '<li>Aucune transaction enregistr√©e localement.</li>';
        return;
    }

    history.forEach(tx => {
        const listItem = document.createElement('li');
        const statusColor = tx.status === 'Succ√®s' ? 'green' : (tx.status.includes('√âchec') || tx.status.includes('R√©seau') ? 'red' : 'orange');
        
        listItem.innerHTML = `
            <div>
                <strong>${tx.type}</strong> (${tx.date})<br>
                √Ä: ${tx.recipient}
            </div>
            <div>
                <span style="color: ${statusColor}; font-weight: bold;">${tx.status}</span>
                <br>
                ${tx.type === "Abonnement Premium" ? '-' : ''}${tx.amount} Gdes
            </div>
        `;
        transactionList.appendChild(listItem);
    });
}

/**
 * Enregistre la transaction dans le KV Global via le Worker de transaction.
 * (Fonction inchang√©e)
 */
async function saveToGlobalKV(senderId, amount, senderName) {
    const transactionData = {
        action: "transfer_money",
        amount: amount,
        senderId: senderId, 
        senderName: senderName || "Utilisateur MIJO",
        recipient: "MIJO CIN√â / Entreprise",
        type: "Abonnement Premium CIN√â"
    };
    
    try {
        const response = await fetch(GLOBAL_HISTORY_WORKER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transactionData)
        });

        if (!response.ok) {
            console.error("√âchec de l'enregistrement KV global, Statut:", response.status);
        }
    } catch (error) {
        console.error("Erreur de connexion lors de l'enregistrement KV global:", error);
    }
}

/**
 * G√®re l'activation ou la d√©sactivation de l'auto-renouvellement.
 */
async function toggleAutoRenew() {
    const userString = localStorage.getItem('user');
    let user = JSON.parse(userString);
    
    if (!user || !user.userId) {
        alert("Utilisateur non connect√©.");
        return;
    }
    
    // Si AutoRenew n'est pas d√©fini, on suppose qu'il est actif par d√©faut
    const currentState = user.AutoRenew === true; 
    const newState = !currentState;
    
    const actionText = newState ? "R√©activer" : "D√©sactiver";
    const confirmation = confirm(`Voulez-vous ${actionText} le renouvellement automatique de votre abonnement Premium ?`);
    
    if (!confirmation) {
        return;
    }

    const toggleButton = document.getElementById('toggleRenewButton');
    toggleButton.disabled = true;
    toggleButton.textContent = `Traitement de la ${actionText} des paiements...`;

    try {
        // Envoi de la requ√™te au Worker pour mettre √† jour la base de donn√©es (Airtable/KV)
        const response = await fetch(AUTORENEW_TOGGLE_WORKER_URL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: "toggle_autorenew", // Action pour votre Worker
                userId: user.userId,
                newState: newState // true ou false
            })
        });

        const data = await response.json();
        
        if (data.success) {
            // Mettre √† jour l'√©tat local de l'utilisateur
            user.AutoRenew = newState;
            localStorage.setItem('user', JSON.stringify(user));
            
            updateUI(user);
            alert(`Renouvellement automatique ${newState ? 'r√©activ√©' : 'd√©sactiv√©'} avec succ√®s.`);
        } else {
            alert(data.error || `√âchec de la ${actionText} du renouvellement automatique.`);
        }

    } catch (error) {
        console.error("Erreur lors de la requ√™te de bascule d'auto-renouvellement:", error);
        alert(`Erreur de connexion lors de la ${actionText} du renouvellement.`);
    } finally {
        // R√©activer le bouton
        updateUI(user);
    }
}

/**
 * G√®re le processus d'activation de l'abonnement Premium.
 * (Mise √† jour pour d√©finir AutoRenew √† 'true' par d√©faut apr√®s l'achat initial)
 */
async function activatePremium() {
    // ... (Code de v√©rification d'utilisateur inchang√©) ...
    const userString = localStorage.getItem('user');
    let user;
    try {
        user = JSON.parse(userString);
    } catch (e) {
        alert("Erreur de donn√©es utilisateur. Veuillez vous reconnecter.");
        window.location.href = "index.html";
        return;
    }

    if (!user || !user.userId) {
        alert("Utilisateur non connect√© ou donn√©es manquantes.");
        return;
    }
    
    if (user.EstPremium === true) {
        alert("Votre abonnement Premium est d√©j√† actif.");
        return;
    }
    
    const confirmation = confirm(`Voulez-vous activer MIJO Premium ? Prix : ${PREMIUM_PRICE} Gdes/mois. Le pr√©l√®vement sera effectu√© maintenant.`);
    if (!confirmation) { return; }

    const activateButton = document.getElementById('activateButton');
    activateButton.disabled = true;
    activateButton.textContent = "Traitement...";

    try {
        const response = await fetch(STORE_SCRIPT_URL, {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: "pay_premium",
                senderId: user.userId,
                amount: PREMIUM_PRICE
            })
        });

        const data = await response.json();
        let transactionStatus = "√âchec";

        if (data.success && data.user && data.user.Solde !== undefined) {
            // Mise √† jour de l'objet utilisateur
            user.Solde = data.user.Solde; 
            user.EstPremium = true;
            user.AutoRenew = true; // DEFINI L'AUTO-RENOUVELLEMENT A TRUE LORS DE LA PREMIERE ACTIVATION
            transactionStatus = "Succ√®s";
            
            // 1. Mettez √† jour le localStorage
            localStorage.setItem('user', JSON.stringify(user));
            
            // 2. Mettez √† jour l'affichage de la page IMM√âDIATEMENT
            updateUI(user);
            
            // 3. Enregistrer l'historique
            saveToHistory("Abonnement Premium", PREMIUM_PRICE, transactionStatus, "MIJO PAY", user.userId);
            await saveToGlobalKV(user.userId, PREMIUM_PRICE, user.nom);
            
            alert("Abonnement Premium activ√© avec succ√®s ! Le renouvellement automatique est actif par d√©faut.");
        } else {
            alert(data.error || "√âchec de l'activation de l'abonnement Premium. Solde insuffisant ou erreur serveur.");
            saveToHistory("Abonnement Premium", PREMIUM_PRICE, transactionStatus, "MIJO PAY", user.userId);
        }
    } catch (error) {
        console.error("Erreur lors de la requ√™te:", error);
        alert("Erreur de connexion. Veuillez v√©rifier votre connexion ou le lien du serveur.");
        saveToHistory("Abonnement Premium", PREMIUM_PRICE, "√âchec R√©seau", "MIJO PAY", user.userId);
    } finally {
        updateUI(user); 
    }
}

/**
 * V√©rifie le statut de l'utilisateur au chargement de la page et met √† jour l'UI.
 */
function checkUserStatus() {
    const userString = localStorage.getItem('user');
    let user = null;
    
    try {
        user = JSON.parse(userString);
        // Initialiser AutoRenew √† true si EstPremium est true mais AutoRenew est manquant (pour la migration des anciens utilisateurs)
        if (user && user.EstPremium === true && user.AutoRenew === undefined) {
             user.AutoRenew = true;
             localStorage.setItem('user', JSON.stringify(user));
        }
    } catch (e) {
        console.error("Erreur de donn√©es utilisateur dans localStorage.", e);
    }

    if (!user || !user.userId) {
        // Optionnel: alert("Veuillez vous connecter pour g√©rer votre abonnement Premium.");
    }
    
    updateUI(user);
}


// --- Initialisation au chargement de la page ---
document.addEventListener('DOMContentLoaded', checkUserStatus);</script>
</body>
</html>
