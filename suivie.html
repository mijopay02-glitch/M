<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Financier & Utilisateurs</title>
    <!-- Chargement de Tailwind CSS pour un design moderne et responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chargement de l'icône Lucide (remplace Font Awesome) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Police Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Chargement de Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #0d9488; /* Teal-600 */
        }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
            border-radius: 0.75rem; /* rounded-xl */
        }
        .card:hover { 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .chart-container { 
            height: 350px; 
            max-width: 100%; 
        }
        /* Ajustement pour les icônes Lucide */
        .lucide { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-10 p-6 bg-white shadow-xl rounded-xl border-t-4 border-teal-600">
            <h1 class="text-4xl font-extrabold text-gray-900 flex items-center">
                <i data-lucide="bar-chart-3" class="w-8 h-8 mr-3 text-teal-600"></i>
                Tableau de Bord Analytique
            </h1>
            <p class="text-gray-500 mt-2 text-lg">Synthèse des données utilisateurs et financières en temps réel.</p>
            <div class="mt-5 flex flex-wrap gap-4 items-center">
                <button onclick="fetchData(true)" class="flex items-center bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300">
                    <i data-lucide="rotate-cw" class="lucide mr-2"></i>
                    Actualiser
                </button>
                <button onclick="promptForApiKey()" class="flex items-center bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition duration-300">
                    <i data-lucide="key" class="lucide mr-2"></i>
                    Changer Clé API
                </button>
                <div class="text-sm text-gray-500 py-2 ml-auto">
                    <span id="lastUpdated">Dernière mise à jour: Jamais</span>
                </div>
            </div>
        </header>

        <!-- Section des Statistiques Clés (Key Stats) -->
        <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-2">Indicateurs de Performance</h2>
        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">

            <!-- STAT 1: Solde Total (Focus sur l'utilisateur rec6v8Z0K0G4bwbdE) -->
            <div class="card bg-white p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-gray-500">Solde Total Entreprise</p>
                    <i data-lucide="wallet" class="lucide text-red-500"></i>
                </div>
                <p id="statTotalSolde" class="text-4xl font-extrabold text-gray-900 mt-2">0,00 €</p>
                <p class="text-xs text-gray-400 mt-1">Somme de tous les soldes</p>
            </div>

            <!-- STAT 2: Nombre Total d'Utilisateurs -->
            <div class="card bg-white p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-gray-500">Total Utilisateurs</p>
                    <i data-lucide="users" class="lucide text-blue-500"></i>
                </div>
                <p id="statTotalUsers" class="text-4xl font-extrabold text-gray-900 mt-2">0</p>
                <p class="text-xs text-gray-400 mt-1">Total des enregistrements</p>
            </div>

            <!-- STAT 3: Utilisateurs Premium -->
            <div class="card bg-white p-6 border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-gray-500">Comptes Premium</p>
                    <i data-lucide="gem" class="lucide text-yellow-500"></i>
                </div>
                <p id="statPremiumUsers" class="text-4xl font-extrabold text-gray-900 mt-2">0</p>
                <p class="text-xs text-gray-400 mt-1">Avec EstPremium = Vrai</p>
            </div>
            
            <!-- STAT 4: Nombre d'Affiliés -->
            <div class="card bg-white p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-gray-500">Total d'Affiliés</p>
                    <i data-lucide="link" class="lucide text-green-500"></i>
                </div>
                <p id="statTotalAffiliates" class="text-4xl font-extrabold text-gray-900 mt-2">0</p>
                <p class="text-xs text-gray-400 mt-1">Basé sur la colonne nbreAffilie</p>
            </div>
        </div>

        <!-- Section des Graphiques (Charts) -->
        <h2 class="text-2xl font-bold text-gray-800 mb-5 border-b pb-2">Visualisations Détaillées</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- GRAPHIQUE 1: Évolution des Inscriptions -->
            <div class="card bg-white p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Évolution des Inscriptions (Par Jour)</h3>
                <div class="chart-container">
                    <canvas id="registrationChart"></canvas>
                </div>
            </div>

            <!-- GRAPHIQUE 2: Ratio Premium / Standard -->
            <div class="card bg-white p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">Ratio Premium vs Standard</h3>
                <div class="chart-container flex items-center justify-center">
                    <div class="w-full max-w-sm mx-auto h-full pb-8">
                         <canvas id="premiumRatioChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =======================================================================
        // CONFIGURATION (Veuillez insérer votre clé API ici)
        // =======================================================================
        const AIRTABLE_API_URL = "https://api.airtable.com/v0";
        const AIRTABLE_BASE_ID = "appF8kBFp7T7ozO0F"; 
        const AIRTABLE_TABLE_NAME = "Utilisateurs";
        
        // ATTENTION : Insérez votre PAT Airtable CI-DESSOUS (doit commencer par 'pat...')
        const AIRTABLE_API_KEY_DEFAULT = "n"; 
        
        const COMPANY_BALANCE_USER_ID = "rec6v8Z0K0G4bwbdE"; // L'ID pour le solde de l'entreprise
        
        // =======================================================================
        // Variables Globales
        // =======================================================================
        const LOCAL_KEY_API = 'airtableApiKey';
        const AIRTABLE_CACHE_KEY = 'airtableDataCache';

        let airtableApiKey = '';
        let allRecords = [];
        let premiumRatioChartInstance = null;
        let registrationChartInstance = null;

        // Fonction d'affichage des icônes Lucide
        function initializeLucide() {
            lucide.createIcons();
        }

        // =======================================================================
        // Gestion de la Clé API (LocalStorage)
        // =======================================================================

        function loadApiKey() {
            // Utilise la clé par défaut si elle est définie, sinon vérifie le LocalStorage
            if (AIRTABLE_API_KEY_DEFAULT && AIRTABLE_API_KEY_DEFAULT.startsWith('pat')) {
                 airtableApiKey = AIRTABLE_API_KEY_DEFAULT;
                 return true;
            }
            const storedKey = localStorage.getItem(LOCAL_KEY_API);
            if (storedKey) {
                airtableApiKey = storedKey;
                return true;
            }
            return false;
        }

        async function promptForApiKey() {
            const result = await Swal.fire({
                title: 'Entrez votre Clé API Airtable (PAT)',
                html: `
                    <p class="text-sm text-gray-600 mb-3">
                        Cette clé (commençant par 'pat') est nécessaire pour accéder aux données. Elle sera stockée localement dans votre navigateur.
                    </p>
                    <input id="swal-api-key" class="swal2-input" placeholder="Airtable API Key (PAT)" value="${airtableApiKey}">
                `,
                focusConfirm: false,
                confirmButtonText: 'Sauvegarder et Continuer',
                showCancelButton: true,
                preConfirm: () => {
                    const apiKey = document.getElementById('swal-api-key').value.trim();
                    if (!apiKey || !apiKey.startsWith('pat')) {
                        Swal.showValidationMessage('Veuillez entrer une clé PAT valide (doit commencer par "pat").');
                        return false;
                    }
                    return apiKey;
                }
            });

            if (result.isConfirmed) {
                airtableApiKey = result.value;
                localStorage.setItem(LOCAL_KEY_API, airtableApiKey);
                // Si la clé est changée, forcer l'actualisation
                fetchData(true);
            }
        }


        // =======================================================================
        // Fonctions de Récupération de Données (Airtable)
        // =======================================================================

        async function fetchData(forceRefresh = false) {
            if (!loadApiKey()) {
                await promptForApiKey();
                if (!airtableApiKey) return; // Quitter si l'utilisateur annule la saisie
            }

            const cachedData = localStorage.getItem(AIRTABLE_CACHE_KEY);
            if (cachedData && !forceRefresh) {
                // Charger le cache s'il n'y a pas d'actualisation forcée
                try {
                    allRecords = JSON.parse(cachedData);
                    renderStats(allRecords);
                    renderCharts(allRecords);
                    document.getElementById('lastUpdated').textContent = `Dernière mise à jour (Cache): ${new Date().toLocaleTimeString()}`;
                    console.log("Données chargées depuis le cache.");
                    
                    // Tenter l'actualisation silencieuse en arrière-plan pour la prochaine fois
                    setTimeout(() => fetchData(true), 10);
                    return;
                } catch (e) {
                    localStorage.removeItem(AIRTABLE_CACHE_KEY);
                }
            }


            Swal.fire({
                title: 'Chargement en cours...',
                text: 'Récupération des données depuis Airtable. Ceci peut prendre quelques secondes.',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            // Requête Airtable (récupère tous les champs nécessaires)
            const fieldsQuery = [
                "Solde", 
                "EstPremium", 
                "nbreaffilie", 
                "DateInscription"
            ].map(f => `fields%5B%5D=${f}`).join('&');

            // Boucle pour gérer la pagination Airtable
            let offset = null;
            let records = [];

            try {
                do {
                    let url = `${AIRTABLE_API_URL}/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}?${fieldsQuery}`;
                    if (offset) {
                        url += `&offset=${offset}`;
                    }

                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${airtableApiKey}` }
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    records = records.concat(result.records);
                    offset = result.offset;

                } while (offset);

                allRecords = records;

                // Mettre à jour le cache et l'affichage
                localStorage.setItem(AIRTABLE_CACHE_KEY, JSON.stringify(allRecords));
                document.getElementById('lastUpdated').textContent = `Dernière mise à jour: ${new Date().toLocaleTimeString()}`;

                renderStats(allRecords);
                renderCharts(allRecords);

                Swal.close();
                Swal.fire({
                    icon: 'success',
                    title: 'Données Actualisées',
                    text: `${allRecords.length} enregistrements chargés.`,
                    showConfirmButton: false,
                    timer: 2000,
                    toast: true,
                    position: 'top-end'
                });

            } catch (error) {
                console.error("Erreur lors de la récupération des données Airtable:", error);
                
                let errorText = `Impossible de charger les données : ${error.message}.`;
                if (error.message.includes('401')) {
                    errorText = "Erreur d'authentification (401). Vérifiez votre Clé API (PAT).";
                } else if (error.message.includes('404')) {
                    errorText = "Erreur (404). Vérifiez l'ID de Base ou le Nom de la Table.";
                }
                
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Échec de la Connexion',
                    text: errorText,
                    confirmButtonText: 'Compris'
                });
            }
        }

        // =======================================================================
        // Fonctions de Rendu (Stats et Charts)
        // =======================================================================

        function renderStats(records) {
            const totalUsers = records.length;
            
            // 1. Calcul du Solde Total de l'Entreprise (Somme de la colonne Solde)
            let totalSolde = 0;
            records.forEach(r => {
                // Assurez-vous que Solde est un nombre valide
                const solde = parseFloat(r.fields.Solde) || 0; 
                totalSolde += solde;
            });
            
            // 2. Utilisateurs Premium (colonne EstPremium)
            const premiumCount = records.filter(r => r.fields.EstPremium === true).length;

            // 3. Nombre Total d'Affiliés (Somme de la colonne nbreaffilie)
            let totalAffiliates = 0;
            records.forEach(r => {
                // Assurez-vous que nbreaffilie est un nombre valide
                const nbreAffilie = parseInt(r.fields.nbreaffilie, 10) || 0;
                totalAffiliates += nbreAffilie;
            });

            // Mise à jour de l'UI
            document.getElementById('statTotalSolde').textContent = totalSolde.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
            document.getElementById('statTotalUsers').textContent = totalUsers.toLocaleString('fr-FR');
            document.getElementById('statPremiumUsers').textContent = premiumCount.toLocaleString('fr-FR');
            document.getElementById('statTotalAffiliates').textContent = totalAffiliates.toLocaleString('fr-FR');
        }

        function renderCharts(records) {
            if (records.length === 0) return;

            // -------------------------------------------------------------------
            // GRAPHIQUE 1: Évolution des Inscriptions (DateInscription)
            // -------------------------------------------------------------------
            const registrationData = records.reduce((acc, r) => {
                const rawDate = r.fields.DateInscription;
                if (rawDate) {
                    try {
                        // Formater en YYYY-MM-DD
                        const datePart = rawDate.split('T')[0];
                        acc[datePart] = (acc[datePart] || 0) + 1;
                    } catch (e) {
                        console.warn("DateInscription invalide:", rawDate);
                    }
                }
                return acc;
            }, {});

            // Trier par date pour la ligne
            const sortedDates = Object.keys(registrationData).sort();
            const dailyCounts = sortedDates.map(date => registrationData[date]);

            if (registrationChartInstance) registrationChartInstance.destroy();

            const ctxRegistration = document.getElementById('registrationChart').getContext('2d');
            registrationChartInstance = new Chart(ctxRegistration, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Nouvelles Inscriptions',
                        data: dailyCounts,
                        borderColor: 'rgb(13, 148, 136)', /* Couleur Primaire (Teal) */
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            title: { display: true, text: 'Nombre d\'Inscriptions' },
                            ticks: { precision: 0 }
                        },
                        x: { 
                            title: { display: true, text: 'Date' }
                        }
                    }
                }
            });

            // -------------------------------------------------------------------
            // GRAPHIQUE 2: Ratio Premium / Standard (EstPremium)
            // -------------------------------------------------------------------
            const premiumCount = records.filter(r => r.fields.EstPremium === true).length;
            const standardCount = records.length - premiumCount;

            if (premiumRatioChartInstance) premiumRatioChartInstance.destroy();

            const ctxPremium = document.getElementById('premiumRatioChart').getContext('2d');
            premiumRatioChartInstance = new Chart(ctxPremium, {
                type: 'doughnut',
                data: {
                    labels: ['Standard', 'Premium'],
                    datasets: [{
                        data: [standardCount, premiumCount],
                        backgroundColor: ['#3b82f6', '#facc15'], /* Bleu pour Standard, Jaune pour Premium */
                        hoverOffset: 12,
                        spacing: 4,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { padding: 25, usePointStyle: true }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const currentValue = context.raw;
                                    const percentage = (currentValue / total) * 100;
                                    return `${context.label}: ${currentValue} (${percentage.toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // =======================================================================
        // Démarrage de l'Application
        // =======================================================================

        window.onload = function() {
            // Initialiser les icônes
            initializeLucide();
            // Charger la clé API et les données
            fetchData();
        }
    </script>
</body>
</html>

